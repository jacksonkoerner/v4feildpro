<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Review Report - Field Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dot-navy': '#0a1628',
                        'dot-blue': '#1e3a5f',
                        'dot-slate': '#334155',
                        'dot-orange': '#ea580c',
                        'dot-yellow': '#f59e0b',
                        'safety-green': '#16a34a',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .header-stripe { background: repeating-linear-gradient(-45deg, #f59e0b, #f59e0b 10px, #0a1628 10px, #0a1628 20px); height: 4px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .loading-shimmer {
            background: linear-gradient(90deg, rgba(0,0,0,0.03) 25%, rgba(0,0,0,0.06) 50%, rgba(0,0,0,0.03) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .typing-effect {
            animation: fadeIn 0.3s ease-in;
        }
        .editable-area {
            min-height: 50px;
            outline: none;
            padding: 10px 12px;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .editable-area:hover {
            background-color: rgba(30, 58, 95, 0.03);
        }
        .editable-area:focus {
            background-color: rgba(30, 58, 95, 0.06);
            border-color: #1e3a5f;
        }
        .editable-area[data-placeholder]:empty:before {
            content: attr(data-placeholder);
            color: rgba(0,0,0,0.3);
            font-style: italic;
        }
        .section-na {
            opacity: 0.5;
        }
        .section-na .refine-btn {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="header-stripe"></div>

    <div id="app" class="max-w-3xl mx-auto min-h-screen flex flex-col">

        <!-- HEADER -->
        <header class="sticky top-0 z-20 bg-dot-navy text-white">
            <div class="px-4 py-3 flex items-center justify-between">
                <a href="quick-interview.html" class="w-9 h-9 flex items-center justify-center border border-slate-600 hover:bg-slate-800 transition-colors">
                    <i class="fas fa-arrow-left text-slate-400 text-sm"></i>
                </a>
                <div class="text-center flex-1 mx-4">
                    <p class="text-[10px] font-bold text-safety-green uppercase tracking-widest">AI Review</p>
                    <p id="currentDate" class="text-xs text-slate-400"></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportTrainingData()" class="w-9 h-9 flex items-center justify-center border border-slate-600 hover:bg-slate-800 text-violet-400 transition-colors" title="Export for prompt training">
                        <i class="fas fa-database text-sm"></i>
                    </button>
                    <button onclick="saveAndExport()" class="px-3 py-2 bg-safety-green hover:bg-green-700 text-white text-xs font-bold uppercase transition-colors">
                        <i class="fas fa-file-export mr-1"></i>Export
                    </button>
                </div>
            </div>
        </header>

        <!-- REFINE ALL BUTTON -->
        <div class="px-4 pt-4">
            <button id="refineAllBtn" onclick="refineAllSections()" class="w-full p-3 bg-dot-navy hover:bg-dot-blue text-white font-bold uppercase text-sm flex items-center justify-center gap-2 transition-all">
                <i class="fas fa-magic text-dot-yellow"></i>
                <span>Refine All with AI</span>
            </button>
        </div>

        <!-- SECTIONS LIST -->
        <main class="flex-1 p-4 pb-8 space-y-3 overflow-y-auto hide-scrollbar">

            <!-- Weather Section -->
            <div id="weather-section" class="bg-white border-2 border-slate-200" data-section="weather">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-sky-500 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-cloud-sun text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Weather & Site Conditions</p>
                    <button id="weather-refine-btn" onclick="refineSection('weather')" class="refine-btn px-3 py-1.5 bg-sky-500 hover:bg-sky-600 text-white text-xs font-bold uppercase transition-colors">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i>Refine
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="weather-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter weather and site conditions..." oninput="handleOriginalEdit('weather')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">AI Refined</p>
                        <div id="weather-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Click 'Refine' to improve..." oninput="handleEdit('weather')"></div>
                    </div>
                </div>
            </div>

            <!-- Work Summary Section -->
            <div id="activities-section" class="bg-white border-2 border-slate-200" data-section="activities">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-safety-green flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-tasks text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Work Summary</p>
                    <button id="activities-refine-btn" onclick="refineSection('activities')" class="refine-btn px-3 py-1.5 bg-safety-green hover:bg-green-700 text-white text-xs font-bold uppercase transition-colors">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i>Refine
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="activities-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter work summary..." oninput="handleOriginalEdit('activities')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">AI Refined</p>
                        <div id="activities-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Click 'Refine' to improve..." oninput="handleEdit('activities')"></div>
                    </div>
                </div>
            </div>

            <!-- Issues Section -->
            <div id="issues-section" class="bg-white border-2 border-slate-200" data-section="issues">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-red-600 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Issues & Delays</p>
                    <span id="issues-na-badge" class="hidden px-2 py-1 bg-slate-200 text-slate-600 text-[10px] font-bold uppercase">N/A</span>
                    <button id="issues-refine-btn" onclick="refineSection('issues')" class="refine-btn px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-bold uppercase transition-colors">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i>Refine
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="issues-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter issues and delays..." oninput="handleOriginalEdit('issues')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">AI Refined</p>
                        <div id="issues-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Click 'Refine' to improve..." oninput="handleEdit('issues')"></div>
                    </div>
                </div>
            </div>

            <!-- Inspections Section -->
            <div id="inspections-section" class="bg-white border-2 border-slate-200" data-section="inspections">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-violet-600 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-check-double text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">QA/QC Inspections</p>
                    <span id="inspections-na-badge" class="hidden px-2 py-1 bg-slate-200 text-slate-600 text-[10px] font-bold uppercase">N/A</span>
                    <button id="inspections-refine-btn" onclick="refineSection('inspections')" class="refine-btn px-3 py-1.5 bg-violet-600 hover:bg-violet-700 text-white text-xs font-bold uppercase transition-colors">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i>Refine
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="inspections-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter inspections..." oninput="handleOriginalEdit('inspections')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">AI Refined</p>
                        <div id="inspections-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Click 'Refine' to improve..." oninput="handleEdit('inspections')"></div>
                    </div>
                </div>
            </div>

            <!-- Safety Section -->
            <div id="safety-section" class="bg-white border-2 border-slate-200" data-section="safety">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-dot-orange flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-hard-hat text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Safety</p>
                    <button id="safety-refine-btn" onclick="refineSection('safety')" class="refine-btn px-3 py-1.5 bg-dot-orange hover:bg-orange-700 text-white text-xs font-bold uppercase transition-colors">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i>Refine
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="safety-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter safety notes..." oninput="handleOriginalEdit('safety')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">AI Refined</p>
                        <div id="safety-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Click 'Refine' to improve..." oninput="handleEdit('safety')"></div>
                    </div>
                </div>
            </div>

            <!-- Visitors Section -->
            <div id="visitors-section" class="bg-white border-2 border-slate-200" data-section="visitors">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-dot-blue flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-user-tie text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Visitors & Communications</p>
                    <span id="visitors-na-badge" class="hidden px-2 py-1 bg-slate-200 text-slate-600 text-[10px] font-bold uppercase">N/A</span>
                    <button id="visitors-refine-btn" onclick="refineSection('visitors')" class="refine-btn px-3 py-1.5 bg-dot-blue hover:bg-blue-800 text-white text-xs font-bold uppercase transition-colors">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i>Refine
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="visitors-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter visitors and communications..." oninput="handleOriginalEdit('visitors')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">AI Refined</p>
                        <div id="visitors-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Click 'Refine' to improve..." oninput="handleEdit('visitors')"></div>
                    </div>
                </div>
            </div>

            <!-- Photos Section -->
            <div class="bg-white border-2 border-slate-200" data-section="photos">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-dot-navy flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-camera text-dot-yellow text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Progress Photos</p>
                </div>
                <div class="p-3">
                    <div id="photos-grid" class="grid grid-cols-3 md:grid-cols-5 gap-2">
                        <!-- Dynamic photos -->
                    </div>
                </div>
            </div>

        </main>

        <!-- BOTTOM ACTION -->
        <div class="sticky bottom-0 p-4 bg-dot-navy border-t-2 border-dot-yellow">
            <div class="flex gap-2">
                <button onclick="saveAndViewReport()" class="flex-1 p-3 bg-safety-green hover:bg-green-700 text-white text-center font-bold uppercase text-sm transition-colors">
                    <i class="fas fa-save mr-2"></i>Save & View Report
                </button>
                <button onclick="copyToClipboard()" class="px-4 py-3 bg-dot-blue hover:bg-blue-800 text-white transition-colors">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-dot-navy text-center py-2 border-t border-slate-700">
            <p class="text-[10px] text-slate-500 uppercase tracking-widest">DOT Compliant Field Documentation System</p>
        </footer>
    </div>

    <script>
        // ============ STATE ============
        let report = null;
        let refinedData = {};
        let apiKey = '';
        let naSections = {};

        // ============ STORAGE ============
        function getTodayKey() {
            return `fieldvoice_report_${new Date().toISOString().split('T')[0]}`;
        }

        function getReport() {
            const saved = localStorage.getItem(getTodayKey());
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (!parsed.meta) parsed.meta = {};
                    if (!parsed.meta.naMarked) parsed.meta.naMarked = {};
                    if (!parsed.safety) parsed.safety = { hasIncidents: false, noIncidents: false, notes: [] };
                    if (parsed.safety.noIncidents === undefined) parsed.safety.noIncidents = false;
                    if (!parsed.refinedData) parsed.refinedData = {};
                    return parsed;
                } catch (e) {}
            }
            const legacy = localStorage.getItem('fieldvoice_report');
            if (legacy) {
                try {
                    const parsed = JSON.parse(legacy);
                    if (!parsed.meta) parsed.meta = {};
                    if (!parsed.meta.naMarked) parsed.meta.naMarked = {};
                    if (!parsed.safety) parsed.safety = { hasIncidents: false, noIncidents: false, notes: [] };
                    if (parsed.safety.noIncidents === undefined) parsed.safety.noIncidents = false;
                    if (!parsed.refinedData) parsed.refinedData = {};
                    return parsed;
                } catch (e) {}
            }
            return null;
        }

        function saveReport() {
            localStorage.setItem(getTodayKey(), JSON.stringify(report));
            localStorage.setItem('fieldvoice_report', JSON.stringify(report));
        }

        function loadApiKey() {
            const saved = localStorage.getItem('groq_api_key');
            if (saved) {
                apiKey = saved;
            }
        }

        // ============ HANDLE EDITS ============
        function handleEdit(section) {
            const refinedEl = document.getElementById(`${section}-refined`);
            const text = refinedEl.innerText.trim();
            refinedData[section] = text;
            saveRefinedDataToReport();
        }

        function handleOriginalEdit(section) {
            const originalEl = document.getElementById(`${section}-original`);
            const text = originalEl.innerText.trim();

            switch (section) {
                case 'weather':
                    report.overview.weather.jobSiteCondition = text;
                    break;
                case 'activities':
                    if (report.activities.length > 0) {
                        report.activities = [{
                            contractor: 'General',
                            trade: 'General',
                            narrative: text
                        }];
                    } else {
                        report.activities.push({
                            contractor: 'General',
                            trade: 'General',
                            narrative: text
                        });
                    }
                    break;
                case 'issues':
                    report.generalIssues = text ? [text] : [];
                    break;
                case 'inspections':
                    report.qaqcNotes = text ? [text] : [];
                    break;
                case 'safety':
                    report.safety.notes = text ? [text] : [];
                    break;
                case 'visitors':
                    report.visitorsRemarks = text ? [text] : [];
                    break;
            }

            saveReport();
        }

        function saveRefinedDataToReport() {
            if (!report) return;

            if (!report.refinedData) {
                report.refinedData = {};
            }

            Object.keys(refinedData).forEach(section => {
                if (refinedData[section]) {
                    report.refinedData[section] = refinedData[section];
                }
            });

            saveReport();
        }

        // ============ DISPLAY ORIGINAL DATA ============
        function displayOriginalData() {
            if (!report) return;

            const naMarked = report.meta?.naMarked || {};

            // Weather
            const weatherText = report.overview?.weather?.jobSiteCondition ||
                `${report.overview?.weather?.generalCondition || 'N/A'}, High: ${report.overview?.weather?.highTemp || '--'}, Low: ${report.overview?.weather?.lowTemp || '--'}`;
            document.getElementById('weather-original').textContent = weatherText || 'No weather data';

            // Activities
            const activitiesText = report.activities?.map(a => a.narrative).join('\n\n') || 'No activities recorded';
            document.getElementById('activities-original').innerHTML = activitiesText.replace(/\n/g, '<br>') || '<span class="text-slate-400 italic">No data</span>';

            // Issues - check for N/A
            if (naMarked.issues) {
                naSections.issues = true;
                document.getElementById('issues-section').classList.add('section-na');
                document.getElementById('issues-na-badge').classList.remove('hidden');
                document.getElementById('issues-refine-btn').classList.add('hidden');
                document.getElementById('issues-original').innerHTML = '<span class="text-slate-400 italic">N/A - No issues reported</span>';
                document.getElementById('issues-refined').innerHTML = '<span class="text-slate-400 italic">N/A</span>';
                document.getElementById('issues-refined').contentEditable = 'false';
            } else {
                const issuesText = report.generalIssues?.join('\n\n') || 'No issues recorded';
                document.getElementById('issues-original').innerHTML = issuesText.replace(/\n/g, '<br>') || '<span class="text-slate-400 italic">No data</span>';
            }

            // Inspections - check for N/A
            if (naMarked.inspections) {
                naSections.inspections = true;
                document.getElementById('inspections-section').classList.add('section-na');
                document.getElementById('inspections-na-badge').classList.remove('hidden');
                document.getElementById('inspections-refine-btn').classList.add('hidden');
                document.getElementById('inspections-original').innerHTML = '<span class="text-slate-400 italic">N/A - No inspections</span>';
                document.getElementById('inspections-refined').innerHTML = '<span class="text-slate-400 italic">N/A</span>';
                document.getElementById('inspections-refined').contentEditable = 'false';
            } else {
                const inspectionsText = report.qaqcNotes?.join('\n\n') || 'No inspections recorded';
                document.getElementById('inspections-original').innerHTML = inspectionsText.replace(/\n/g, '<br>') || '<span class="text-slate-400 italic">No data</span>';
            }

            // Safety
            let safetyText = '';
            if (report.safety?.hasIncidents) {
                safetyText = 'INCIDENT REPORTED\n\n';
            } else if (report.safety?.noIncidents) {
                safetyText = 'No incidents reported.\n\n';
            }
            safetyText += report.safety?.notes?.join('\n\n') || '';
            document.getElementById('safety-original').innerHTML = safetyText.replace(/\n/g, '<br>') || '<span class="text-slate-400 italic">No data</span>';

            // Visitors - check for N/A
            if (naMarked.visitors) {
                naSections.visitors = true;
                document.getElementById('visitors-section').classList.add('section-na');
                document.getElementById('visitors-na-badge').classList.remove('hidden');
                document.getElementById('visitors-refine-btn').classList.add('hidden');
                document.getElementById('visitors-original').innerHTML = '<span class="text-slate-400 italic">N/A - No visitors</span>';
                document.getElementById('visitors-refined').innerHTML = '<span class="text-slate-400 italic">N/A</span>';
                document.getElementById('visitors-refined').contentEditable = 'false';
            } else {
                const visitorsText = report.visitorsRemarks?.join('\n\n') || 'No visitors recorded';
                document.getElementById('visitors-original').innerHTML = visitorsText.replace(/\n/g, '<br>') || '<span class="text-slate-400 italic">No data</span>';
            }

            // Photos
            const photosGrid = document.getElementById('photos-grid');
            if (report.photos?.length > 0) {
                photosGrid.innerHTML = report.photos.map((p, i) => `
                    <div class="relative bg-slate-100 border border-slate-200 overflow-hidden aspect-square">
                        <img src="${p.url}" class="w-full h-full object-cover">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-1.5">
                            <p class="text-[9px] text-white/80">${p.time || ''}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                photosGrid.innerHTML = '<p class="text-slate-400 italic text-sm col-span-full text-center py-4">No photos</p>';
            }

            // Load previously saved refined data
            if (report.refinedData) {
                Object.keys(report.refinedData).forEach(section => {
                    if (report.refinedData[section] && !naSections[section]) {
                        refinedData[section] = report.refinedData[section];
                        const refinedEl = document.getElementById(`${section}-refined`);
                        if (refinedEl) {
                            refinedEl.innerHTML = report.refinedData[section].replace(/\n/g, '<br>');
                        }
                    }
                });
            }
        }

        // ============ AI REFINEMENT ============
        async function refineSection(section) {
            if (naSections[section]) {
                showToast('Cannot refine N/A sections', 'warning');
                return;
            }

            if (!apiKey) {
                const goToSetup = confirm('API key required for AI refinement.\n\nWould you like to set up your Groq API key now?');
                if (goToSetup) {
                    window.location.href = 'permissions.html#apiKeyCard';
                }
                return;
            }

            const originalEl = document.getElementById(`${section}-original`);
            const refinedEl = document.getElementById(`${section}-refined`);
            const originalText = originalEl.textContent;

            if (!originalText || originalText === 'No data' || originalText.includes('N/A') || originalText.includes('No ') && originalText.includes(' recorded')) {
                refinedEl.innerHTML = '<span class="text-slate-400 italic">Nothing to refine</span>';
                return;
            }

            // Show loading state
            refinedEl.innerHTML = '<div class="loading-shimmer p-3 h-12"></div>';
            refinedEl.contentEditable = 'false';

            try {
                const sectionPrompts = {
                    weather: 'Rewrite this weather and site conditions description in clear, professional language suitable for a construction daily report:',
                    activities: 'Rewrite this work summary in clear, professional language suitable for a construction daily report. Use proper grammar and professional terminology:',
                    issues: 'Rewrite this issues and delays description in clear, professional language suitable for a construction daily report. Be specific and actionable:',
                    inspections: 'Rewrite this QA/QC inspections note in clear, professional language suitable for a construction daily report:',
                    safety: 'Rewrite this safety report in clear, professional language suitable for a construction daily report. Maintain accuracy of any incident information:',
                    visitors: 'Rewrite this visitors and communications note in clear, professional language suitable for a construction daily report:'
                };

                const currentDate = new Date().toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                let systemPrompt = '';
                if (section === 'safety' && report.safety?.hasIncidents) {
                    systemPrompt = `You are a professional construction safety report writer. Today's date is ${currentDate}. Follow these rules strictly:

1. INCIDENT REPORT FORMAT:
   - Use this exact structure for incident reports:
     Incident Report
     Date: ${currentDate}
     Time: [Extract from text if mentioned, or state "Unknown"]
     Location: [Extract from text if mentioned, or state "Unknown"]
     Incident Description: [What happened]
     Details: [Additional relevant details from the text]
     Injuries/Consequences: [Only what is stated in the text, or "Unknown at this time"]
     Actions Taken: [Only what is stated in the text]
     Recommendations: [Only if mentioned in original text, otherwise omit this line]
     Next Steps: [Only if mentioned in original text, otherwise omit this line]

2. FORMATTING RULES:
   - Use dashes (-) for any lists, NOT asterisks (*) or bullet points
   - NEVER use asterisks (*) or markdown bold/italic formatting
   - NEVER use placeholder text like [Insert Date] - always use the actual date provided above
   - Use plain text only

3. ACCURACY RULES - CRITICAL:
   - ONLY include information explicitly stated in the original text
   - NEVER add, invent, assume, or infer any details not provided
   - If information is unknown, state "Unknown at this time" rather than leaving placeholders
   - Do not add equipment, tools, methods, or details that were not mentioned

4. OUTPUT:
   - Return ONLY the refined incident report, nothing else
   - No quotes around the output
   - No explanations or commentary`;
                } else {
                    systemPrompt = `You are a professional construction report writer. Today's date is ${currentDate}. Follow these rules strictly:

1. FORMATTING RULES:
   - Write in plain paragraph form only
   - NEVER use asterisks (*) or markdown bold/italic formatting
   - If you need to list items, use dashes (-) NOT asterisks or bullet points
   - NEVER use headers, titles, or section labels
   - Write complete sentences in flowing prose
   - Keep it concise - 1-3 sentences maximum
   - NEVER use placeholder text like [Insert Date] - always use today's date: ${currentDate}

2. ACCURACY RULES - CRITICAL:
   - ONLY include information explicitly stated in the original text
   - NEVER add, invent, assume, or infer any details not provided
   - If someone's name is mentioned, only state what they did as described
   - Do not add equipment, tools, methods, or details that were not mentioned
   - If something is unclear, keep it simple rather than elaborating

3. OUTPUT:
   - Return ONLY the refined text, nothing else
   - No quotes around the output
   - No explanations or commentary`;
                }

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instant',
                        messages: [
                            {
                                role: 'system',
                                content: systemPrompt
                            },
                            {
                                role: 'user',
                                content: `${sectionPrompts[section]}\n\nOriginal text: "${originalText}"`
                            }
                        ],
                        temperature: 0.2,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const refinedText = data.choices[0]?.message?.content || 'Error refining text';

                refinedData[section] = refinedText;

                refinedEl.innerHTML = '';
                refinedEl.contentEditable = 'true';
                const p = document.createElement('span');
                p.className = 'typing-effect';
                p.innerHTML = refinedText.replace(/\n/g, '<br>');
                refinedEl.appendChild(p);

                saveRefinedDataToReport();

            } catch (error) {
                console.error('Refinement error:', error);
                refinedEl.innerHTML = `<span class="text-red-600">Error: ${error.message}</span>`;
                refinedEl.contentEditable = 'true';
            }
        }

        async function refineAllSections() {
            const sections = ['weather', 'activities', 'issues', 'inspections', 'safety', 'visitors'];
            const btn = document.getElementById('refineAllBtn');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refining...';

            for (const section of sections) {
                if (naSections[section]) continue;

                await refineSection(section);
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check mr-2"></i>All Refined!';

            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-magic text-dot-yellow"></i><span>Refine All with AI</span>';
            }, 3000);
        }

        // ============ SAVE & VIEW ============
        function saveAndViewReport() {
            const sections = ['weather', 'activities', 'issues', 'inspections', 'safety', 'visitors'];
            sections.forEach(section => {
                if (!naSections[section]) {
                    const refinedEl = document.getElementById(`${section}-refined`);
                    const text = refinedEl.innerText.trim();
                    if (text && !text.includes('Click') && !text.includes('Nothing to refine')) {
                        refinedData[section] = text;
                    }
                }
            });

            saveRefinedDataToReport();
            showToast('Report saved!');

            setTimeout(() => {
                window.location.href = 'report.html';
            }, 500);
        }

        function saveAndExport() {
            saveRefinedDataToReport();

            let exportText = `DAILY REPORT - ${report?.overview?.date || new Date().toLocaleDateString()}\n`;
            exportText += `Project: ${report?.overview?.projectName || 'N/A'}\n`;
            exportText += `${'='.repeat(50)}\n\n`;

            const sections = [
                { id: 'weather', title: 'WEATHER & SITE CONDITIONS' },
                { id: 'activities', title: 'WORK SUMMARY' },
                { id: 'issues', title: 'ISSUES & DELAYS' },
                { id: 'inspections', title: 'QA/QC INSPECTIONS' },
                { id: 'safety', title: 'SAFETY' },
                { id: 'visitors', title: 'VISITORS & COMMUNICATIONS' }
            ];

            sections.forEach(section => {
                exportText += `${section.title}\n${'-'.repeat(section.title.length)}\n`;

                if (naSections[section.id]) {
                    exportText += 'N/A\n\n';
                } else {
                    const refined = refinedData[section.id];
                    const original = document.getElementById(`${section.id}-original`)?.textContent;
                    exportText += (refined || original || 'N/A') + '\n\n';
                }
            });

            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `daily-report-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportTrainingData() {
            saveRefinedDataToReport();

            const currentDate = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            let exportText = `GROQ TRAINING DATA EXPORT\n`;
            exportText += `${'='.repeat(50)}\n`;
            exportText += `Date: ${currentDate}\n`;
            exportText += `Project: ${report?.overview?.projectName || 'N/A'}\n`;
            exportText += `${'='.repeat(50)}\n\n`;

            const sections = [
                { id: 'weather', title: 'WEATHER & SITE CONDITIONS' },
                { id: 'activities', title: 'WORK SUMMARY' },
                { id: 'issues', title: 'ISSUES & DELAYS' },
                { id: 'inspections', title: 'QA/QC INSPECTIONS' },
                { id: 'safety', title: 'SAFETY' },
                { id: 'visitors', title: 'VISITORS & COMMUNICATIONS' }
            ];

            sections.forEach(section => {
                exportText += `${'='.repeat(50)}\n`;
                exportText += `${section.title}\n`;
                exportText += `${'='.repeat(50)}\n\n`;

                if (naSections[section.id]) {
                    exportText += `[SECTION MARKED N/A]\n\n`;
                } else {
                    const originalEl = document.getElementById(`${section.id}-original`);
                    const refinedEl = document.getElementById(`${section.id}-refined`);

                    const originalText = originalEl?.innerText?.trim() || '';
                    const refinedText = refinedEl?.innerText?.trim() || '';

                    exportText += `--- HUMAN INPUT ---\n`;
                    exportText += `${originalText || '[No input provided]'}\n\n`;

                    exportText += `--- AI REFINED ---\n`;
                    if (refinedText && !refinedText.includes('Click') && !refinedText.includes('Nothing to refine')) {
                        exportText += `${refinedText}\n\n`;
                    } else {
                        exportText += `[Not refined]\n\n`;
                    }
                }
            });

            exportText += `${'='.repeat(50)}\n`;
            exportText += `END OF TRAINING DATA\n`;
            exportText += `${'='.repeat(50)}\n`;

            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `training-data-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Training data exported!');
        }

        function copyToClipboard() {
            let copyText = '';

            const sections = ['weather', 'activities', 'issues', 'inspections', 'safety', 'visitors'];
            sections.forEach(section => {
                if (naSections[section]) {
                    return;
                }
                const refined = refinedData[section];
                const original = document.getElementById(`${section}-original`)?.textContent;
                if (refined || original) {
                    copyText += (refined || original) + '\n\n';
                }
            });

            navigator.clipboard.writeText(copyText).then(() => {
                showToast('Copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }

        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast-msg');
            if (existing) existing.remove();

            const colors = { success: 'bg-safety-green', warning: 'bg-dot-orange', error: 'bg-red-600', info: 'bg-dot-blue' };
            const toast = document.createElement('div');
            toast.className = `toast-msg fixed bottom-24 left-1/2 -translate-x-1/2 ${colors[type] || colors.success} text-white px-6 py-3 font-bold text-sm shadow-lg z-50 flex items-center gap-2 uppercase`;
            toast.innerHTML = `<i class="fas fa-check"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });

            report = getReport();

            if (!report) {
                document.querySelector('main').innerHTML = `
                    <div class="text-center py-12 bg-white border-2 border-slate-200">
                        <i class="fas fa-inbox text-3xl text-slate-300 mb-3"></i>
                        <p class="text-slate-500 uppercase text-sm font-bold mb-4">No report found</p>
                        <a href="index.html" class="inline-block px-4 py-2 bg-dot-navy text-white font-bold uppercase text-sm">Go to Dashboard</a>
                    </div>
                `;
                return;
            }

            loadApiKey();
            displayOriginalData();
        });
    </script>
</body>
</html>
