<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Report - FieldVoice Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media print {
            .print-hidden { display: none !important; }
            .page-break { page-break-before: always; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            @page { margin: 0.5in; }
            .report-page { max-width: 8.5in; min-height: 11in; }
        }
        @media screen {
            .report-page { max-width: 100%; }
        }
        @media screen and (min-width: 768px) {
            .report-page { max-width: 8.5in; min-height: auto; }
        }
        .table-scroll-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 4px;
        }
        .table-scroll-wrapper table {
            min-width: 600px;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen overflow-x-hidden">

    <!-- NAVIGATION BAR (hidden on print) -->
    <div class="print-hidden sticky top-0 z-50 bg-white border-b shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 text-slate-600 font-bold hover:text-slate-800 transition-colors">
                <i class="fas fa-arrow-left"></i>
                <span class="hidden sm:inline">Back to Dashboard</span>
            </a>
            <div class="flex items-center gap-2">
                <a href="interview.html" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-bold text-sm hover:bg-indigo-200 transition-colors">
                    <i class="fas fa-edit mr-1"></i> Edit
                </a>
                <button onclick="window.print()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold text-sm shadow-md hover:bg-emerald-700 transition-colors">
                    <i class="fas fa-print mr-1"></i> Print / PDF
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto p-4 sm:p-8 print:p-0 print:max-w-none">

        <!-- PAGE 1: OVERVIEW & WORK SUMMARY -->
        <div id="page1" class="report-page bg-white border-4 border-slate-900 p-1 mb-8 print:mb-0 print:border-2">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-2 border-b-2 border-slate-900 pb-2 mb-4 px-2">
                <div class="flex items-center gap-2 sm:gap-4">
                    <div class="w-10 h-10 sm:w-14 sm:h-14 bg-slate-200 flex items-center justify-center text-[7px] sm:text-[8px] font-bold rounded flex-shrink-0">LOGO</div>
                    <div>
                        <h1 class="text-base sm:text-xl font-black uppercase tracking-tighter">RPR Daily Report</h1>
                        <p class="text-[9px] sm:text-[10px] text-slate-500 font-bold uppercase">Resident Project Representative</p>
                    </div>
                </div>
                <div class="text-[10px] sm:text-xs font-bold text-left sm:text-right">
                    <div id="reportDate" class="text-slate-600"></div>
                    <div>Page 1 of <span id="totalPages">4</span></div>
                </div>
            </div>

            <!-- Project Overview Section -->
            <div class="bg-emerald-900 text-white text-center font-bold py-1 uppercase text-sm mb-2 mx-1">
                Project Overview
            </div>
            <div id="overviewGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-0 border border-slate-900 text-[10px] mx-1 mb-4 overflow-hidden">
                <!-- Filled by JS -->
            </div>

            <!-- Daily Work Summary Section -->
            <div class="bg-emerald-900 text-white text-center font-bold py-1 uppercase text-sm mb-2 mx-1">
                Daily Work Summary
            </div>
            <div id="workSummary" class="text-[10px] px-3 py-2 space-y-4 min-h-[350px]">
                <!-- Filled by JS -->
            </div>
        </div>

        <!-- PAGE 2: TABLES -->
        <div id="page2" class="report-page bg-white border-4 border-slate-900 p-1 mb-8 print:mb-0 print:border-2 page-break">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-2 border-b-2 border-slate-900 pb-2 mb-4 px-2">
                <div class="flex items-center gap-2 sm:gap-4">
                    <div class="w-10 h-10 sm:w-14 sm:h-14 bg-slate-200 flex items-center justify-center text-[7px] sm:text-[8px] font-bold rounded flex-shrink-0">LOGO</div>
                    <h1 class="text-base sm:text-xl font-black uppercase tracking-tighter">RPR Daily Report</h1>
                </div>
                <div class="text-[10px] sm:text-xs font-bold">Page 2 of <span class="totalPages">4</span></div>
            </div>

            <!-- Daily Operations Table -->
            <div class="bg-emerald-900 text-white text-center font-bold py-1 uppercase text-sm mb-2 mx-1">
                Daily Operations (Personnel On-Site)
            </div>
            <div class="table-scroll-wrapper mb-6">
                <table id="operationsTable" class="w-full text-[9px] border-collapse border border-slate-900">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="border border-slate-900 p-1.5 text-left font-black whitespace-nowrap">CONTRACTOR</th>
                            <th class="border border-slate-900 p-1.5 text-left font-black whitespace-nowrap">TRADE</th>
                            <th class="border border-slate-900 p-1.5 text-center font-black whitespace-nowrap">SUPER(S)</th>
                            <th class="border border-slate-900 p-1.5 text-center font-black whitespace-nowrap">FOREMAN</th>
                            <th class="border border-slate-900 p-1.5 text-center font-black whitespace-nowrap">OPERATOR(S)</th>
                            <th class="border border-slate-900 p-1.5 text-center font-black whitespace-nowrap">LABORER(S)</th>
                            <th class="border border-slate-900 p-1.5 text-center font-black whitespace-nowrap">OTHER(S)</th>
                            <th class="border border-slate-900 p-1.5 text-center font-black whitespace-nowrap bg-emerald-100">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="operationsBody">
                        <!-- Filled by JS -->
                    </tbody>
                    <tfoot id="operationsFoot" class="bg-slate-50 font-bold">
                        <!-- Filled by JS -->
                    </tfoot>
                </table>
            </div>

            <!-- Equipment Table -->
            <div class="bg-emerald-900 text-white text-center font-bold py-1 uppercase text-sm mb-2 mx-1">
                Mobilized Equipment & Daily Utilization
            </div>
            <div class="table-scroll-wrapper">
                <table class="w-full text-[9px] border-collapse border border-slate-900">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="border border-slate-900 p-1.5 text-left font-black whitespace-nowrap">CONTRACTOR</th>
                            <th class="border border-slate-900 p-1.5 text-left font-black whitespace-nowrap">EQUIPMENT TYPE / MODEL</th>
                            <th class="border border-slate-900 p-1.5 text-center font-black whitespace-nowrap">QTY</th>
                            <th class="border border-slate-900 p-1.5 text-left font-black whitespace-nowrap">STATUS / NOTES</th>
                        </tr>
                    </thead>
                    <tbody id="equipmentBody">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PAGE 3: ISSUES, QA/QC, SAFETY -->
        <div id="page3" class="report-page bg-white border-4 border-slate-900 p-1 mb-8 print:mb-0 print:border-2 page-break">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-2 border-b-2 border-slate-900 pb-2 mb-4 px-2">
                <div class="flex items-center gap-2 sm:gap-4">
                    <div class="w-10 h-10 sm:w-14 sm:h-14 bg-slate-200 flex items-center justify-center text-[7px] sm:text-[8px] font-bold rounded flex-shrink-0">LOGO</div>
                    <h1 class="text-base sm:text-xl font-black uppercase tracking-tighter">RPR Daily Report</h1>
                </div>
                <div class="text-[10px] sm:text-xs font-bold">Page 3 of <span class="totalPages">4</span></div>
            </div>

            <!-- Issues & Delays -->
            <div class="bg-emerald-900 text-white text-center font-bold py-1 uppercase text-sm mb-2 mx-1">
                Issues, Delays & RFIs
            </div>
            <div id="issuesSection" class="text-[10px] px-3 py-2 mb-4 min-h-[80px] border border-slate-200 mx-1 rounded">
                <!-- Filled by JS -->
            </div>

            <!-- Communications & Visitors -->
            <div class="bg-emerald-900 text-white text-center font-bold py-1 uppercase text-sm mb-2 mx-1">
                Communications & Visitors
            </div>
            <div id="visitorsSection" class="text-[10px] px-3 py-2 mb-4 min-h-[60px] border border-slate-200 mx-1 rounded">
                <!-- Filled by JS -->
            </div>

            <!-- QA/QC Inspections -->
            <div class="bg-emerald-900 text-white text-center font-bold py-1 uppercase text-sm mb-2 mx-1">
                QA/QC Testing & Inspections
            </div>
            <div id="qaqcSection" class="text-[10px] px-3 py-2 mb-4 min-h-[80px] border border-slate-200 mx-1 rounded">
                <!-- Filled by JS -->
            </div>

            <!-- Safety & Incidents -->
            <div class="bg-emerald-900 text-white text-center font-bold py-1 uppercase text-sm mb-2 mx-1">
                Safety & Incidents
            </div>
            <div id="safetySection" class="text-[10px] px-3 py-2 min-h-[80px] border border-slate-200 mx-1 rounded">
                <!-- Filled by JS -->
            </div>

            <!-- Signature Block -->
            <div class="mt-8 mx-1 border-t-2 border-slate-900 pt-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4">
                    <div class="text-[9px] text-slate-500 font-bold uppercase">
                        Report prepared by Resident Project Representative
                    </div>
                    <div class="text-right w-full sm:w-auto">
                        <div id="signatureLine" class="border-b border-slate-900 w-full sm:w-56 mb-1 h-8 flex items-end justify-center">
                            <span class="italic font-serif text-lg text-slate-700"></span>
                        </div>
                        <div class="text-[8px] font-bold text-slate-500 uppercase">RPR Signature / Date</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE 4: PHOTOS (conditional) -->
        <div id="page4" class="report-page bg-white border-4 border-slate-900 p-1 mb-8 print:mb-0 print:border-2 page-break hidden">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-2 border-b-2 border-slate-900 pb-2 mb-4 px-2">
                <div class="flex items-center gap-2 sm:gap-4">
                    <div class="w-10 h-10 sm:w-14 sm:h-14 bg-slate-200 flex items-center justify-center text-[7px] sm:text-[8px] font-bold rounded flex-shrink-0">LOGO</div>
                    <h1 class="text-base sm:text-xl font-black uppercase tracking-tighter">RPR Daily Report</h1>
                </div>
                <div class="text-[10px] sm:text-xs font-bold">Page 4 of <span class="totalPages">4</span></div>
            </div>

            <!-- Photos Section -->
            <div class="bg-emerald-900 text-white text-center font-bold py-1 uppercase text-sm mb-4 mx-1">
                Daily Progress Photos
            </div>
            <div id="photosGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 px-3">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <script>
        // ============ STATE MANAGEMENT ============
        function getReportKey() {
            const params = new URLSearchParams(window.location.search);
            return params.get('key') || getTodayKey();
        }

        function getTodayKey() {
            return `fieldvoice_report_${new Date().toISOString().split('T')[0]}`;
        }

        function getReport() {
            const key = getReportKey();

            // Try specific key first
            const saved = localStorage.getItem(key);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Ensure required properties exist for legacy reports
                    if (!parsed.meta) parsed.meta = {};
                    if (!parsed.meta.naMarked) parsed.meta.naMarked = {};
                    if (!parsed.safety) parsed.safety = { hasIncidents: false, noIncidents: false, notes: [] };
                    if (!parsed.refinedData) parsed.refinedData = {};
                    return parsed;
                } catch (e) {}
            }

            // Fallback to legacy key
            const legacy = localStorage.getItem('fieldvoice_report');
            if (legacy) {
                try {
                    const parsed = JSON.parse(legacy);
                    // Ensure required properties exist for legacy reports
                    if (!parsed.meta) parsed.meta = {};
                    if (!parsed.meta.naMarked) parsed.meta.naMarked = {};
                    if (!parsed.safety) parsed.safety = { hasIncidents: false, noIncidents: false, notes: [] };
                    if (!parsed.refinedData) parsed.refinedData = {};
                    return parsed;
                } catch (e) {}
            }

            return getInitialReport();
        }

        function getInitialReport() {
            return {
                overview: {
                    projectName: "North-South Connector Road Phase 2",
                    noabProjectNo: "1291",
                    cnoSolicitationNo: "N/A",
                    noticeToProceed: "June 27th, 2025",
                    contractDuration: "467 days",
                    expectedCompletion: "October 7th, 2026",
                    contractDayNo: "-- of 467 days",
                    weatherDays: "0 days",
                    date: new Date().toLocaleDateString(),
                    location: "Louis Armstrong New Orleans Int'l Airport",
                    engineer: "Garver, LLC",
                    contractor: "Hunt, Gibbs, Boh, & Metro (HGBM)",
                    startTime: "6:00 AM",
                    endTime: "4:00 PM",
                    shiftDuration: "10.00 hours",
                    completedBy: "Inspector Name, RPR",
                    weather: {
                        highTemp: "--",
                        lowTemp: "--",
                        precipitation: "0.00\"",
                        generalCondition: "--",
                        jobSiteCondition: "Dry",
                        adverseConditions: "N/A",
                    },
                },
                contractors: [],
                activities: [],
                operations: [],
                equipment: [],
                generalIssues: [],
                communications: [],
                qaqcNotes: [],
                safety: { hasIncidents: false, notes: [] },
                visitorsRemarks: [],
                photos: [],
            };
        }

        // ============ RENDER REPORT ============
        function renderReport() {
            const report = getReport();
            const o = report.overview;
            const w = o.weather || {};

            // Update document title
            document.title = `Daily Report - ${o.date} - FieldVoice Pro`;
            document.getElementById('reportDate').textContent = o.date;

            // Page 1: Overview Grid
            document.getElementById('overviewGrid').innerHTML = `
                <div class="sm:border-r border-b border-slate-900 p-2">
                    <span class="font-black text-slate-600">PROJECT NAME:</span><br>
                    <span class="font-bold break-words">${o.projectName}</span>
                </div>
                <div class="border-b border-slate-900 p-2">
                    <span class="font-black text-slate-600">DATE:</span><br>
                    <span class="font-bold">${o.date}</span>
                </div>

                <div class="sm:border-r border-b border-slate-900 p-2">
                    <span class="font-black text-slate-600">NOAB PROJECT NO:</span><br>
                    <span class="font-bold">${o.noabProjectNo}</span>
                </div>
                <div class="border-b border-slate-900 p-2">
                    <span class="font-black text-slate-600">LOCATION:</span><br>
                    <span class="font-bold break-words">${o.location}</span>
                </div>

                <div class="sm:border-r border-b border-slate-900 p-2">
                    <span class="font-black text-slate-600">NOTICE TO PROCEED:</span><br>
                    <span class="font-bold">${o.noticeToProceed}</span>
                </div>
                <div class="border-b border-slate-900 p-2">
                    <span class="font-black text-slate-600">ENGINEER:</span><br>
                    <span class="font-bold break-words">${o.engineer}</span>
                </div>

                <div class="sm:border-r border-b border-slate-900 p-2">
                    <span class="font-black text-slate-600">CONTRACT DURATION:</span><br>
                    <span class="font-bold">${o.contractDuration}</span>
                </div>
                <div class="border-b border-slate-900 p-2">
                    <span class="font-black text-slate-600">PRIME CONTRACTOR:</span><br>
                    <span class="font-bold break-words">${o.contractor}</span>
                </div>

                <div class="sm:border-r border-b border-slate-900 p-2">
                    <span class="font-black text-slate-600">CONTRACT DAY NO:</span><br>
                    <span class="font-bold">${o.contractDayNo}</span>
                </div>
                <div class="border-b border-slate-900 p-2">
                    <span class="font-black text-slate-600">SHIFT HOURS:</span><br>
                    <span class="font-bold">${o.startTime || '--'} - ${o.endTime || '--'} (${o.shiftDuration || '--'})</span>
                </div>

                <div class="sm:border-r border-b sm:border-b-0 border-slate-900 p-2">
                    <span class="font-black text-slate-600">WEATHER CONDITIONS:</span><br>
                    <div class="grid grid-cols-2 gap-1 mt-1">
                        <span>High: <strong>${w.highTemp || '--'}</strong></span>
                        <span>Low: <strong>${w.lowTemp || '--'}</strong></span>
                        <span>Precip: <strong>${w.precipitation || '--'}</strong></span>
                        <span>Condition: <strong>${w.generalCondition || '--'}</strong></span>
                    </div>
                    <div class="mt-1">
                        <span>Site Condition: <strong class="${w.jobSiteCondition === 'Wet' ? 'text-blue-600' : 'text-emerald-600'}">${w.jobSiteCondition || 'Dry'}</strong></span>
                    </div>
                </div>
                <div class="p-2 flex flex-col justify-between">
                    <div>
                        <span class="font-black text-slate-600">COMPLETED BY:</span>
                    </div>
                    <div class="text-right mt-2">
                        <div class="border-b border-slate-900 w-full mb-1 pb-1 text-center italic font-serif text-base break-words">${o.completedBy}</div>
                        <div class="text-[8px] font-black text-slate-500 uppercase">RPR Name & Title</div>
                    </div>
                </div>
            `;

            // Page 1: Work Summary - check for refined data first
            const workSummary = document.getElementById('workSummary');
            const refinedActivities = report.refinedData?.activities;

            if (refinedActivities) {
                // Use refined text if available
                workSummary.innerHTML = `
                    <p class="font-bold text-slate-700 mb-3">Construction Activities Performed and Observed on this Date:</p>
                    <div class="mb-4 pb-3">
                        <p class="text-slate-700 leading-relaxed">${refinedActivities.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            } else if (report.activities.length === 0) {
                workSummary.innerHTML = `
                    <p class="font-bold text-slate-700 mb-2">Construction Activities Performed and Observed on this Date:</p>
                    <p class="italic text-slate-400">No work summary recorded for today.</p>
                `;
            } else {
                workSummary.innerHTML = `
                    <p class="font-bold text-slate-700 mb-3">Construction Activities Performed and Observed on this Date:</p>
                    ${report.activities.map(act => `
                        <div class="mb-4 pb-3 border-b border-slate-100 last:border-0">
                            <p class="font-black uppercase text-emerald-800 mb-1">${act.contractor} â€“ ${act.trade || 'GENERAL CONTRACTOR'}</p>
                            <p class="text-slate-700 leading-relaxed">${act.narrative || 'Work performed - details not recorded.'}</p>
                            ${act.equipmentSummary ? `<p class="mt-1"><span class="font-bold text-slate-600">EQUIPMENT:</span> ${act.equipmentSummary}</p>` : ''}
                            ${act.crewSummary ? `<p class="mt-1"><span class="font-bold text-slate-600">CREW:</span> ${act.crewSummary}</p>` : ''}
                        </div>
                    `).join('')}
                `;
            }

            // Page 2: Operations Table
            const operationsBody = document.getElementById('operationsBody');
            const operationsFoot = document.getElementById('operationsFoot');

            if (report.operations.length > 0) {
                let totals = { supers: 0, foreman: 0, operators: 0, laborers: 0, others: 0, total: 0 };

                operationsBody.innerHTML = report.operations.map(row => {
                    const s = parseInt(row.supers) || 0;
                    const f = parseInt(row.foreman) || 0;
                    const op = parseInt(row.operators) || 0;
                    const l = parseInt(row.laborers) || 0;
                    const ot = parseInt(row.others) || 0;
                    const rowTotal = s + f + op + l + ot;

                    totals.supers += s;
                    totals.foreman += f;
                    totals.operators += op;
                    totals.laborers += l;
                    totals.others += ot;
                    totals.total += rowTotal;

                    return `
                        <tr>
                            <td class="border border-slate-900 p-1.5 font-bold">${row.contractor}</td>
                            <td class="border border-slate-900 p-1.5">${row.trade || 'General'}</td>
                            <td class="border border-slate-900 p-1.5 text-center">${s || '-'}</td>
                            <td class="border border-slate-900 p-1.5 text-center">${f || '-'}</td>
                            <td class="border border-slate-900 p-1.5 text-center">${op || '-'}</td>
                            <td class="border border-slate-900 p-1.5 text-center">${l || '-'}</td>
                            <td class="border border-slate-900 p-1.5 text-center">${ot || '-'}</td>
                            <td class="border border-slate-900 p-1.5 text-center font-bold bg-emerald-50">${rowTotal}</td>
                        </tr>
                    `;
                }).join('');

                operationsFoot.innerHTML = `
                    <tr>
                        <td colspan="2" class="border border-slate-900 p-1.5 text-right font-black">DAILY TOTALS:</td>
                        <td class="border border-slate-900 p-1.5 text-center font-bold">${totals.supers || '-'}</td>
                        <td class="border border-slate-900 p-1.5 text-center font-bold">${totals.foreman || '-'}</td>
                        <td class="border border-slate-900 p-1.5 text-center font-bold">${totals.operators || '-'}</td>
                        <td class="border border-slate-900 p-1.5 text-center font-bold">${totals.laborers || '-'}</td>
                        <td class="border border-slate-900 p-1.5 text-center font-bold">${totals.others || '-'}</td>
                        <td class="border border-slate-900 p-1.5 text-center font-black text-lg bg-emerald-100">${totals.total}</td>
                    </tr>
                `;
            } else {
                operationsBody.innerHTML = '<tr><td colspan="8" class="border border-slate-900 p-3 text-center italic text-slate-400">No personnel recorded for this date.</td></tr>';
                operationsFoot.innerHTML = '';
            }

            // Page 2: Equipment Table
            const equipmentBody = document.getElementById('equipmentBody');
            equipmentBody.innerHTML = report.equipment.length > 0
                ? report.equipment.map(row => `
                    <tr>
                        <td class="border border-slate-900 p-1.5 font-bold">${row.contractor}</td>
                        <td class="border border-slate-900 p-1.5">${row.model}</td>
                        <td class="border border-slate-900 p-1.5 text-center font-bold">${row.quantity}</td>
                        <td class="border border-slate-900 p-1.5 text-slate-600">${row.notes || 'Active'}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="4" class="border border-slate-900 p-3 text-center italic text-slate-400">No equipment mobilized or recorded.</td></tr>';

            // Page 3: Issues - check for refined data first
            const issuesSection = document.getElementById('issuesSection');
            const refinedIssues = report.refinedData?.issues;
            const naMarked = report.meta?.naMarked || {};

            if (naMarked.issues) {
                issuesSection.innerHTML = '<p class="italic text-slate-400">N/A - No issues reported.</p>';
            } else if (refinedIssues) {
                issuesSection.innerHTML = `<p class="text-slate-700">${refinedIssues.replace(/\n/g, '<br>')}</p>`;
            } else if (report.generalIssues.length > 0) {
                issuesSection.innerHTML = `<ul class="list-disc list-inside space-y-1">${report.generalIssues.map(issue => `<li>${issue}</li>`).join('')}</ul>`;
            } else {
                issuesSection.innerHTML = '<p class="italic text-slate-400">No issues, delays, or RFIs reported.</p>';
            }

            // Page 3: Visitors - check for refined data first
            const visitorsSection = document.getElementById('visitorsSection');
            const refinedVisitors = report.refinedData?.visitors;

            if (naMarked.visitors) {
                visitorsSection.innerHTML = '<p class="italic text-slate-400">N/A - No visitors.</p>';
            } else if (refinedVisitors) {
                visitorsSection.innerHTML = `<p class="text-slate-700">${refinedVisitors.replace(/\n/g, '<br>')}</p>`;
            } else {
                const visitorsContent = [
                    ...(report.visitorsRemarks || []),
                    ...(report.communications || [])
                ];
                visitorsSection.innerHTML = visitorsContent.length > 0
                    ? `<ul class="list-disc list-inside space-y-1">${visitorsContent.map(v => `<li>${v}</li>`).join('')}</ul>`
                    : '<p class="italic text-slate-400">No visitors or significant communications recorded.</p>';
            }

            // Page 3: QA/QC - check for refined data first
            const qaqcSection = document.getElementById('qaqcSection');
            const refinedInspections = report.refinedData?.inspections;

            if (naMarked.inspections) {
                qaqcSection.innerHTML = '<p class="italic text-slate-400">N/A - No inspections.</p>';
            } else if (refinedInspections) {
                qaqcSection.innerHTML = `<p class="text-slate-700">${refinedInspections.replace(/\n/g, '<br>')}</p>`;
            } else if (report.qaqcNotes.length > 0) {
                qaqcSection.innerHTML = `<ul class="list-disc list-inside space-y-1">${report.qaqcNotes.map(note => `<li>${note}</li>`).join('')}</ul>`;
            } else {
                qaqcSection.innerHTML = '<p class="italic text-slate-400">No QA/QC inspections or testing recorded.</p>';
            }

            // Page 3: Safety - check for refined data first
            const safetySection = document.getElementById('safetySection');
            const refinedSafety = report.refinedData?.safety;
            const safety = report.safety || { hasIncidents: false, notes: [] };

            safetySection.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[9px] font-bold uppercase ${safety.hasIncidents ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}">
                        <i class="fas ${safety.hasIncidents ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
                        ${safety.hasIncidents ? 'Incidents Reported' : 'No Incidents'}
                    </span>
                </div>
                ${refinedSafety
                    ? `<p class="text-slate-700">${refinedSafety.replace(/\n/g, '<br>')}</p>`
                    : (safety.notes && safety.notes.length > 0
                        ? `<ul class="list-disc list-inside space-y-1">${safety.notes.map(note => `<li>${note}</li>`).join('')}</ul>`
                        : '<p class="italic text-slate-400">No additional safety notes.</p>'
                    )
                }
            `;

            // Signature line
            document.getElementById('signatureLine').querySelector('span').textContent = o.completedBy;

            // Page 4: Photos (conditional)
            const page4 = document.getElementById('page4');
            const photosGrid = document.getElementById('photosGrid');

            if (report.photos && report.photos.length > 0) {
                page4.classList.remove('hidden');
                photosGrid.innerHTML = report.photos.map(p => `
                    <div class="border border-slate-300 rounded overflow-hidden">
                        <img src="${p.url}" class="w-full h-40 object-cover" alt="${p.caption || 'Site photo'}">
                        <div class="p-2 bg-slate-50 text-[9px]">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-bold text-slate-600">${p.date || '--'}</span>
                                <span class="text-slate-400">${p.time || ''}</span>
                            </div>
                            <p class="text-slate-700">${p.caption || 'No caption provided.'}</p>
                            ${p.gps ? `<p class="text-slate-400 mt-1 text-[8px]"><i class="fas fa-map-marker-alt mr-1"></i>${p.gps.lat.toFixed(5)}, ${p.gps.lng.toFixed(5)}</p>` : ''}
                        </div>
                    </div>
                `).join('');

                // Update page counts
                document.getElementById('totalPages').textContent = '4';
                document.querySelectorAll('.totalPages').forEach(el => el.textContent = '4');
            } else {
                page4.classList.add('hidden');
                document.getElementById('totalPages').textContent = '3';
                document.querySelectorAll('.totalPages').forEach(el => el.textContent = '3');
            }
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', renderReport);
    </script>
</body>
</html>
