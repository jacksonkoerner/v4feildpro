<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily Report - Field Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dot-navy': '#0a1628',
                        'dot-blue': '#1e3a5f',
                        'dot-slate': '#334155',
                        'dot-orange': '#ea580c',
                        'dot-yellow': '#f59e0b',
                        'safety-green': '#16a34a',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .header-stripe {
            background: repeating-linear-gradient(-45deg, #f59e0b, #f59e0b 10px, #0a1628 10px, #0a1628 20px);
            height: 4px;
        }
        @keyframes pulse-recording {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(234, 88, 12, 0); }
        }
        .recording-pulse { animation: pulse-recording 1.5s ease-out infinite; }
        .section-card { transition: all 0.3s ease; }
        .section-card.expanded { border-color: #1e3a5f; box-shadow: 0 0 0 2px rgba(30, 58, 95, 0.2); }
        .section-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .section-card.expanded .section-content { max-height: 1000px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="header-stripe"></div>

    <div id="app" class="max-w-lg mx-auto min-h-screen flex flex-col">

        <!-- Permissions Warning Banner -->
        <div id="permissionsWarningBanner" class="hidden bg-dot-orange">
            <div class="px-4 py-3 flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-white"></i>
                <p class="flex-1 text-sm text-white font-medium">Some features require permissions</p>
                <a href="permissions.html" class="px-3 py-1.5 bg-white text-dot-orange font-bold text-xs">Enable</a>
                <button onclick="dismissWarningBanner()" class="text-white/80 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- HEADER -->
        <header class="sticky top-0 z-20 bg-dot-navy text-white">
            <div class="p-4 flex items-center justify-between">
                <a href="index.html" class="w-10 h-10 flex items-center justify-center border border-slate-600 hover:bg-slate-800 transition-colors">
                    <i class="fas fa-arrow-left text-slate-400"></i>
                </a>
                <div class="text-center flex-1 mx-4">
                    <p class="text-[10px] font-bold text-dot-yellow uppercase tracking-widest">Full Report</p>
                    <p id="currentDate" class="text-sm text-slate-400"></p>
                </div>
                <button onclick="finishReport()" class="px-4 py-2 bg-safety-green hover:bg-green-700 text-white text-sm font-bold uppercase transition-colors">
                    Finish
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="px-4 pb-3 flex items-center gap-3">
                <div class="flex-1 h-2 bg-slate-700 overflow-hidden">
                    <div id="progressBar" class="h-full bg-dot-yellow transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="progressText" class="text-xs font-bold text-slate-400">0%</span>
            </div>
        </header>

        <!-- SECTIONS LIST -->
        <main class="flex-1 p-4 pb-8 space-y-3 overflow-y-auto hide-scrollbar">

            <!-- Weather Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="weather">
                <button onclick="toggleSection('weather')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-blue flex items-center justify-center">
                        <i class="fas fa-cloud-sun text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Weather & Site Conditions</p>
                        <p id="weather-preview" class="text-sm text-slate-500 truncate">Tap to add</p>
                    </div>
                    <div id="weather-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <div class="bg-slate-50 border border-slate-200 p-3">
                            <div class="grid grid-cols-3 gap-3 text-sm">
                                <div>
                                    <span class="text-slate-400 text-xs uppercase">Condition</span>
                                    <p id="weather-condition" class="font-bold text-slate-700">--</p>
                                </div>
                                <div>
                                    <span class="text-slate-400 text-xs uppercase">Temp</span>
                                    <p id="weather-temp" class="font-bold text-slate-700">--</p>
                                </div>
                                <div>
                                    <span class="text-slate-400 text-xs uppercase">Precip</span>
                                    <p id="weather-precip" class="font-bold text-slate-700">--</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Site Conditions</label>
                            <div class="mt-2 flex items-center gap-2">
                                <textarea id="site-conditions-input" class="flex-1 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue resize-none" rows="2" placeholder="Describe site conditions..."></textarea>
                                <button onclick="recordVoice('weather')" class="voice-btn w-12 h-12 bg-dot-navy hover:bg-dot-blue flex items-center justify-center text-white transition-all">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contractors Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="contractors">
                <button onclick="toggleSection('contractors')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-orange flex items-center justify-center">
                        <i class="fas fa-users text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Contractors On Site</p>
                        <p id="contractors-preview" class="text-sm text-slate-500 truncate">Tap to add</p>
                    </div>
                    <div id="contractors-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <div id="contractor-chips" class="flex flex-wrap gap-2"></div>
                        <div class="flex items-center gap-2">
                            <input type="text" id="contractor-input" class="flex-1 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue" placeholder="Add contractor name...">
                            <button onclick="addContractor()" class="px-4 py-3 bg-dot-orange hover:bg-orange-700 text-white font-bold transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('contractors')" class="voice-btn w-12 h-12 bg-dot-navy hover:bg-dot-blue flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Work Summary Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="activities">
                <button onclick="toggleSection('activities')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-safety-green flex items-center justify-center">
                        <i class="fas fa-tasks text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Work Summary</p>
                        <p id="activities-preview" class="text-sm text-slate-500 truncate">Tap to add</p>
                    </div>
                    <div id="activities-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <div id="activities-list" class="space-y-2"></div>
                        <div class="flex items-center gap-2">
                            <textarea id="activity-input" class="flex-1 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue resize-none" rows="2" placeholder="Describe work performed..."></textarea>
                            <button onclick="addActivity()" class="px-4 py-3 bg-safety-green hover:bg-green-700 text-white font-bold transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('activities')" class="voice-btn w-12 h-12 bg-dot-navy hover:bg-dot-blue flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Headcounts Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="headcounts">
                <button onclick="toggleSection('headcounts')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-blue flex items-center justify-center">
                        <i class="fas fa-clipboard-list text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Personnel Counts</p>
                        <p id="headcounts-preview" class="text-sm text-slate-500 truncate">Tap to add</p>
                    </div>
                    <div id="headcounts-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <div id="headcounts-list" class="space-y-2"></div>
                        <div class="flex items-center gap-2">
                            <input type="text" id="headcount-input" class="flex-1 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue" placeholder="e.g. HGBM: 2 supers, 8 laborers">
                            <button onclick="addHeadcount()" class="px-4 py-3 bg-dot-blue hover:bg-blue-800 text-white font-bold transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('headcounts')" class="voice-btn w-12 h-12 bg-dot-navy hover:bg-dot-blue flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="equipment">
                <button onclick="toggleSection('equipment')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-yellow flex items-center justify-center">
                        <i class="fas fa-truck-pickup text-dot-navy text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Equipment</p>
                        <p id="equipment-preview" class="text-sm text-slate-500 truncate">Tap to add</p>
                    </div>
                    <div id="equipment-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <button onclick="markNA('equipment')" id="equipment-na-btn" class="w-full p-3 bg-slate-100 border border-slate-300 text-slate-600 hover:bg-slate-200 transition-colors text-sm font-medium uppercase">
                            <i class="fas fa-ban mr-2"></i>Mark as N/A
                        </button>
                        <div id="equipment-list" class="space-y-2"></div>
                        <div class="flex items-center gap-2">
                            <input type="text" id="equipment-input" class="flex-1 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue" placeholder="e.g. Cat 320 Excavator">
                            <button onclick="addEquipment()" class="px-4 py-3 bg-dot-yellow hover:bg-yellow-600 text-dot-navy font-bold transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('equipment')" class="voice-btn w-12 h-12 bg-dot-navy hover:bg-dot-blue flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Issues Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="issues">
                <button onclick="toggleSection('issues')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-red-600 flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Issues & Delays</p>
                        <p id="issues-preview" class="text-sm text-slate-500 truncate">None reported</p>
                    </div>
                    <div id="issues-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <button onclick="markNA('issues')" id="issues-na-btn" class="w-full p-3 bg-slate-100 border border-slate-300 text-slate-600 hover:bg-slate-200 transition-colors text-sm font-medium uppercase">
                            <i class="fas fa-check mr-2"></i>No Issues - Mark as N/A
                        </button>
                        <div id="issues-list" class="space-y-2"></div>
                        <div class="flex items-center gap-2">
                            <textarea id="issue-input" class="flex-1 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue resize-none" rows="2" placeholder="Describe any issues or delays..."></textarea>
                            <button onclick="addIssue()" class="px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-bold transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('issues')" class="voice-btn w-12 h-12 bg-dot-navy hover:bg-dot-blue flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inspections Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="inspections">
                <button onclick="toggleSection('inspections')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-violet-600 flex items-center justify-center">
                        <i class="fas fa-check-double text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">QA/QC Inspections</p>
                        <p id="inspections-preview" class="text-sm text-slate-500 truncate">None reported</p>
                    </div>
                    <div id="inspections-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <button onclick="markNA('inspections')" id="inspections-na-btn" class="w-full p-3 bg-slate-100 border border-slate-300 text-slate-600 hover:bg-slate-200 transition-colors text-sm font-medium uppercase">
                            <i class="fas fa-ban mr-2"></i>No Inspections - Mark as N/A
                        </button>
                        <div id="inspections-list" class="space-y-2"></div>
                        <div class="flex items-center gap-2">
                            <textarea id="inspection-input" class="flex-1 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue resize-none" rows="2" placeholder="Describe inspections or testing..."></textarea>
                            <button onclick="addInspection()" class="px-4 py-3 bg-violet-600 hover:bg-violet-700 text-white font-bold transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('inspections')" class="voice-btn w-12 h-12 bg-dot-navy hover:bg-dot-blue flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Safety Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="safety">
                <button onclick="toggleSection('safety')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-safety-green flex items-center justify-center">
                        <i class="fas fa-hard-hat text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Safety</p>
                        <p id="safety-preview" class="text-sm text-slate-500 truncate">No incidents</p>
                    </div>
                    <div id="safety-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-3 p-3 bg-safety-green/10 border-2 border-safety-green cursor-pointer">
                                <input type="checkbox" id="no-incidents" class="w-5 h-5">
                                <span class="font-medium text-safety-green text-sm uppercase">No Incidents</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-red-50 border-2 border-red-500 cursor-pointer">
                                <input type="checkbox" id="has-incidents" class="w-5 h-5">
                                <span class="font-medium text-red-600 text-sm uppercase">Incident</span>
                            </label>
                        </div>
                        <div id="safety-list" class="space-y-2"></div>
                        <div class="flex items-center gap-2">
                            <textarea id="safety-input" class="flex-1 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue resize-none" rows="2" placeholder="Safety notes, toolbox talks..."></textarea>
                            <button onclick="addSafetyNote()" class="px-4 py-3 bg-safety-green hover:bg-green-700 text-white font-bold transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('safety')" class="voice-btn w-12 h-12 bg-dot-navy hover:bg-dot-blue flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visitors Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="visitors">
                <button onclick="toggleSection('visitors')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-blue flex items-center justify-center">
                        <i class="fas fa-user-tie text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Visitors & Communications</p>
                        <p id="visitors-preview" class="text-sm text-slate-500 truncate">None reported</p>
                    </div>
                    <div id="visitors-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <button onclick="markNA('visitors')" id="visitors-na-btn" class="w-full p-3 bg-slate-100 border border-slate-300 text-slate-600 hover:bg-slate-200 transition-colors text-sm font-medium uppercase">
                            <i class="fas fa-ban mr-2"></i>No Visitors - Mark as N/A
                        </button>
                        <div id="visitors-list" class="space-y-2"></div>
                        <div class="flex items-center gap-2">
                            <textarea id="visitor-input" class="flex-1 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue resize-none" rows="2" placeholder="Visitors, calls, communications..."></textarea>
                            <button onclick="addVisitor()" class="px-4 py-3 bg-dot-blue hover:bg-blue-800 text-white font-bold transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="recordVoice('visitors')" class="voice-btn w-12 h-12 bg-dot-navy hover:bg-dot-blue flex items-center justify-center text-white transition-all">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Photos Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="photos">
                <button onclick="toggleSection('photos')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-navy flex items-center justify-center">
                        <i class="fas fa-camera text-dot-yellow text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Progress Photos</p>
                        <p id="photos-preview" class="text-sm text-slate-500 truncate">No photos</p>
                    </div>
                    <div id="photos-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <label class="block cursor-pointer">
                            <input type="file" accept="image/*" capture="environment" multiple class="hidden" id="photoInput">
                            <div class="border-2 border-dashed border-slate-300 p-6 text-center hover:border-dot-blue hover:bg-slate-50 transition-colors">
                                <i class="fas fa-camera text-2xl text-slate-400 mb-2"></i>
                                <p class="font-bold text-slate-600 uppercase text-sm">Tap to Add Photos</p>
                                <p class="text-xs text-slate-400">GPS location will be captured</p>
                            </div>
                        </label>
                        <div id="photos-grid" class="grid grid-cols-2 gap-2"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Voice Recording Modal -->
    <div id="voiceModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm">
            <div class="bg-dot-navy text-white p-4 text-center">
                <p id="voiceModalTitle" class="text-lg font-bold uppercase">Recording...</p>
                <p class="text-xs text-slate-400">Tap stop when finished</p>
            </div>

            <div id="voiceTranscript" class="bg-slate-50 p-4 m-4 border border-slate-200 min-h-[100px] max-h-[200px] overflow-y-auto">
                <p id="liveTranscript" class="text-sm text-slate-600 italic">Listening...</p>
            </div>

            <div class="p-4 pt-0 flex justify-center gap-4">
                <button onclick="cancelVoice()" class="px-6 py-3 bg-slate-200 text-slate-700 font-bold uppercase hover:bg-slate-300 transition-colors">
                    Cancel
                </button>
                <button id="stopVoiceBtn" onclick="stopVoice()" class="recording-pulse px-6 py-3 bg-dot-orange text-white font-bold uppercase">
                    <i class="fas fa-stop mr-2"></i>Stop
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============ STATE ============
        let currentSection = null;
        let isRecording = false;
        let recognition = null;
        let currentTranscript = '';
        let activeVoiceSection = null;
        let report = null;

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOSSafari = isIOS && isSafari;
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        // ============ STORAGE ============
        function getTodayKey() {
            return `fieldvoice_report_${new Date().toISOString().split('T')[0]}`;
        }

        function getReport() {
            const saved = localStorage.getItem(getTodayKey());
            if (saved) {
                try { return JSON.parse(saved); } catch (e) {}
            }
            return createFreshReport();
        }

        function createFreshReport() {
            return {
                meta: { createdAt: new Date().toISOString(), interviewCompleted: false, version: 2 },
                overview: {
                    projectName: "North-South Connector Road Phase 2",
                    date: new Date().toLocaleDateString(),
                    startTime: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                    weather: { highTemp: "--", lowTemp: "--", precipitation: "0.00\"", generalCondition: "Syncing...", jobSiteCondition: "", adverseConditions: "N/A" }
                },
                contractors: [],
                activities: [],
                operations: [],
                equipment: [],
                generalIssues: [],
                qaqcNotes: [],
                safety: { hasIncidents: false, notes: [] },
                visitorsRemarks: [],
                photos: []
            };
        }

        function saveReport() {
            localStorage.setItem(getTodayKey(), JSON.stringify(report));
            localStorage.setItem('fieldvoice_report', JSON.stringify(report));
            updateAllPreviews();
            updateProgress();
        }

        // ============ WEATHER ============
        async function fetchWeather() {
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
                });
                const { latitude, longitude } = position.coords;
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto&temperature_unit=fahrenheit&precipitation_unit=inch`
                );
                const data = await response.json();
                const weatherCodes = { 0: 'Clear', 1: 'Mostly Clear', 2: 'Partly Cloudy', 3: 'Overcast', 45: 'Fog', 48: 'Fog', 51: 'Light Drizzle', 53: 'Drizzle', 55: 'Heavy Drizzle', 61: 'Light Rain', 63: 'Rain', 65: 'Heavy Rain', 80: 'Showers', 95: 'Thunderstorm' };
                const precip = data.daily.precipitation_sum[0];
                report.overview.weather = {
                    highTemp: `${Math.round(data.daily.temperature_2m_max[0])}°F`,
                    lowTemp: `${Math.round(data.daily.temperature_2m_min[0])}°F`,
                    precipitation: `${precip.toFixed(2)}"`,
                    generalCondition: weatherCodes[data.current_weather.weathercode] || 'Cloudy',
                    jobSiteCondition: report.overview.weather.jobSiteCondition || (precip > 0.1 ? 'Wet' : 'Dry'),
                    adverseConditions: precip > 0.25 ? 'Rain impact possible' : 'N/A'
                };
                saveReport();
                updateWeatherDisplay();
            } catch (error) {
                console.error('Weather fetch failed:', error);
            }
        }

        function updateWeatherDisplay() {
            const w = report.overview.weather;
            document.getElementById('weather-condition').textContent = w.generalCondition;
            document.getElementById('weather-temp').textContent = `${w.highTemp} / ${w.lowTemp}`;
            document.getElementById('weather-precip').textContent = w.precipitation;
            document.getElementById('site-conditions-input').value = w.jobSiteCondition || '';
        }

        // ============ SECTION TOGGLE ============
        function toggleSection(sectionId) {
            const cards = document.querySelectorAll('.section-card');
            cards.forEach(card => {
                if (card.dataset.section === sectionId) {
                    card.classList.toggle('expanded');
                    const icon = card.querySelector('[id$="-status"] i');
                    if (card.classList.contains('expanded')) {
                        icon.className = 'fas fa-chevron-up text-dot-blue text-xs';
                    } else {
                        icon.className = 'fas fa-chevron-down text-slate-400 text-xs';
                    }
                } else {
                    card.classList.remove('expanded');
                    const icon = card.querySelector('[id$="-status"] i');
                    icon.className = 'fas fa-chevron-down text-slate-400 text-xs';
                }
            });
        }

        // ============ VOICE RECORDING ============
        function recordVoice(section) {
            activeVoiceSection = section;
            currentTranscript = '';
            document.getElementById('liveTranscript').textContent = 'Listening...';
            document.getElementById('voiceModal').classList.remove('hidden');
            const sectionNames = { weather: 'Site Conditions', contractors: 'Contractors', activities: 'Work Summary', headcounts: 'Headcounts', equipment: 'Equipment', issues: 'Issues', inspections: 'Inspections', safety: 'Safety', visitors: 'Visitors' };
            document.getElementById('voiceModalTitle').textContent = `Recording: ${sectionNames[section]}`;
            startRecording();
        }

        function startRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("Speech Recognition not supported. Please use Chrome or Safari.");
                cancelVoice();
                return;
            }
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.onstart = () => { isRecording = true; };
            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = 0; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                currentTranscript = transcript;
                document.getElementById('liveTranscript').textContent = transcript || 'Listening...';
            };
            recognition.onend = () => { isRecording = false; };
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    cancelVoice();
                    alert('Microphone access is required for voice recording.');
                }
            };
            recognition.start();
        }

        function stopVoice() {
            if (recognition) { recognition.stop(); recognition = null; }
            isRecording = false;
            const transcript = currentTranscript.trim();
            if (transcript) { applyVoiceToSection(activeVoiceSection, transcript); }
            document.getElementById('voiceModal').classList.add('hidden');
            currentTranscript = '';
            activeVoiceSection = null;
        }

        function cancelVoice() {
            if (recognition) { recognition.stop(); recognition = null; }
            isRecording = false;
            currentTranscript = '';
            activeVoiceSection = null;
            document.getElementById('voiceModal').classList.add('hidden');
        }

        function applyVoiceToSection(section, transcript) {
            switch (section) {
                case 'weather':
                    report.overview.weather.jobSiteCondition = transcript;
                    document.getElementById('site-conditions-input').value = transcript;
                    break;
                case 'contractors':
                    const contractors = transcript.split(/,|and|&/).map(c => c.trim()).filter(c => c);
                    contractors.forEach(c => {
                        const normalized = normalizeContractorName(c);
                        if (!report.contractors.includes(normalized)) { report.contractors.push(normalized); }
                    });
                    break;
                case 'activities':
                    report.activities.push({ contractor: report.contractors[0] || 'General', trade: 'General', narrative: transcript });
                    break;
                case 'headcounts':
                    parseAndAddHeadcount(transcript);
                    break;
                case 'equipment':
                    report.equipment.push({ contractor: report.contractors[0] || 'General', model: transcript, quantity: 1, notes: '' });
                    break;
                case 'issues':
                    if (!transcript.toLowerCase().includes('none') && !transcript.toLowerCase().includes('no issues')) {
                        report.generalIssues.push(transcript);
                    }
                    break;
                case 'inspections':
                    if (!transcript.toLowerCase().includes('none') && !transcript.toLowerCase().includes('no inspection')) {
                        report.qaqcNotes.push(transcript);
                    }
                    break;
                case 'safety':
                    report.safety.notes.push(transcript);
                    if (transcript.toLowerCase().includes('incident') || transcript.toLowerCase().includes('injury')) {
                        report.safety.hasIncidents = true;
                    }
                    break;
                case 'visitors':
                    if (!transcript.toLowerCase().includes('none') && !transcript.toLowerCase().includes('no visitor')) {
                        report.visitorsRemarks.push(transcript);
                    }
                    break;
            }
            saveReport();
            renderSection(section);
            showToast('Added successfully');
        }

        // ============ MANUAL ADD FUNCTIONS ============
        function addContractor() {
            const input = document.getElementById('contractor-input');
            const name = input.value.trim();
            if (name) {
                const normalized = normalizeContractorName(name);
                if (!report.contractors.includes(normalized)) {
                    report.contractors.push(normalized);
                    saveReport();
                    renderSection('contractors');
                }
                input.value = '';
            }
        }

        function removeContractor(index) {
            report.contractors.splice(index, 1);
            saveReport();
            renderSection('contractors');
        }

        function addActivity() {
            const input = document.getElementById('activity-input');
            const text = input.value.trim();
            if (text) {
                report.activities.push({ contractor: report.contractors[0] || 'General', trade: 'General', narrative: text });
                saveReport();
                renderSection('activities');
                input.value = '';
            }
        }

        function removeActivity(index) {
            report.activities.splice(index, 1);
            saveReport();
            renderSection('activities');
        }

        function addHeadcount() {
            const input = document.getElementById('headcount-input');
            const text = input.value.trim();
            if (text) {
                parseAndAddHeadcount(text);
                saveReport();
                renderSection('headcounts');
                input.value = '';
            }
        }

        function parseAndAddHeadcount(text) {
            let contractor = report.contractors[0] || 'General';
            const colonIndex = text.indexOf(':');
            if (colonIndex > 0) {
                contractor = normalizeContractorName(text.substring(0, colonIndex).trim());
                text = text.substring(colonIndex + 1);
            }
            const counts = { supers: 0, foreman: 0, operators: 0, laborers: 0, others: 0 };
            const patterns = [
                { regex: /(\d+)\s*(?:super|superintendent)/i, field: 'supers' },
                { regex: /(\d+)\s*(?:foreman|foremen)/i, field: 'foreman' },
                { regex: /(\d+)\s*(?:operator|operators)/i, field: 'operators' },
                { regex: /(\d+)\s*(?:laborer|laborers|workers|guys)/i, field: 'laborers' }
            ];
            patterns.forEach(p => {
                const match = text.match(p.regex);
                if (match) counts[p.field] = parseInt(match[1]) || 0;
            });
            if (Object.values(counts).every(v => v === 0)) {
                const numMatch = text.match(/(\d+)/);
                if (numMatch) counts.laborers = parseInt(numMatch[1]) || 0;
            }
            report.operations.push({ contractor: contractor, trade: 'General', ...counts });
        }

        function removeHeadcount(index) {
            report.operations.splice(index, 1);
            saveReport();
            renderSection('headcounts');
        }

        function addEquipment() {
            const input = document.getElementById('equipment-input');
            const text = input.value.trim();
            if (text) {
                report.equipment.push({ contractor: report.contractors[0] || 'General', model: text, quantity: 1, notes: '' });
                saveReport();
                renderSection('equipment');
                input.value = '';
            }
        }

        function removeEquipment(index) {
            report.equipment.splice(index, 1);
            saveReport();
            renderSection('equipment');
        }

        function addIssue() {
            const input = document.getElementById('issue-input');
            const text = input.value.trim();
            if (text) {
                report.generalIssues.push(text);
                saveReport();
                renderSection('issues');
                input.value = '';
            }
        }

        function removeIssue(index) {
            report.generalIssues.splice(index, 1);
            saveReport();
            renderSection('issues');
        }

        function addInspection() {
            const input = document.getElementById('inspection-input');
            const text = input.value.trim();
            if (text) {
                report.qaqcNotes.push(text);
                saveReport();
                renderSection('inspections');
                input.value = '';
            }
        }

        function removeInspection(index) {
            report.qaqcNotes.splice(index, 1);
            saveReport();
            renderSection('inspections');
        }

        function addSafetyNote() {
            const input = document.getElementById('safety-input');
            const text = input.value.trim();
            if (text) {
                report.safety.notes.push(text);
                saveReport();
                renderSection('safety');
                input.value = '';
            }
        }

        function removeSafetyNote(index) {
            report.safety.notes.splice(index, 1);
            saveReport();
            renderSection('safety');
        }

        function addVisitor() {
            const input = document.getElementById('visitor-input');
            const text = input.value.trim();
            if (text) {
                report.visitorsRemarks.push(text);
                saveReport();
                renderSection('visitors');
                input.value = '';
            }
        }

        function removeVisitor(index) {
            report.visitorsRemarks.splice(index, 1);
            saveReport();
            renderSection('visitors');
        }

        // ============ PHOTOS ============
        async function handlePhotoInput(e) {
            const files = e.target.files;
            if (!files) return;
            for (const file of files) {
                let gps = null;
                try {
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000, enableHighAccuracy: true, maximumAge: 60000 });
                    });
                    gps = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy };
                } catch (err) { console.warn('Photo GPS failed:', err); }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    report.photos.push({
                        id: `photo_${Date.now()}`,
                        url: ev.target.result,
                        caption: '',
                        timestamp: new Date().toISOString(),
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                        gps: gps
                    });
                    saveReport();
                    renderSection('photos');
                    showToast('Photo added', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        function removePhoto(index) {
            report.photos.splice(index, 1);
            saveReport();
            renderSection('photos');
        }

        // ============ RENDER SECTIONS ============
        function renderSection(section) {
            switch (section) {
                case 'contractors':
                    const chipsContainer = document.getElementById('contractor-chips');
                    chipsContainer.innerHTML = report.contractors.map((c, i) => `
                        <div class="flex items-center gap-1 bg-dot-orange text-white px-3 py-1.5 text-sm font-medium">
                            <span>${c}</span>
                            <button onclick="removeContractor(${i})" class="ml-1 hover:text-yellow-300"><i class="fas fa-times text-xs"></i></button>
                        </div>
                    `).join('') || '<p class="text-slate-400 text-sm">No contractors added</p>';
                    break;
                case 'activities':
                    const activitiesList = document.getElementById('activities-list');
                    activitiesList.innerHTML = report.activities.map((a, i) => `
                        <div class="bg-slate-50 border border-slate-200 p-3 flex items-start gap-3">
                            <div class="flex-1">
                                <p class="text-xs font-bold text-safety-green uppercase">${a.contractor}</p>
                                <p class="text-sm text-slate-700 mt-1">${a.narrative}</p>
                            </div>
                            <button onclick="removeActivity(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    `).join('') || '';
                    break;
                case 'headcounts':
                    const headcountsList = document.getElementById('headcounts-list');
                    headcountsList.innerHTML = report.operations.map((o, i) => {
                        const total = (o.supers||0) + (o.foreman||0) + (o.operators||0) + (o.laborers||0) + (o.others||0);
                        return `
                            <div class="bg-slate-50 border border-slate-200 p-3 flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-bold text-slate-700">${o.contractor}</p>
                                    <p class="text-xs text-slate-500">${total} workers (S:${o.supers||0} F:${o.foreman||0} O:${o.operators||0} L:${o.laborers||0})</p>
                                </div>
                                <button onclick="removeHeadcount(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                            </div>
                        `;
                    }).join('') || '';
                    break;
                case 'equipment':
                    const equipmentList = document.getElementById('equipment-list');
                    equipmentList.innerHTML = report.equipment.map((e, i) => `
                        <div class="bg-slate-50 border border-slate-200 p-3 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-bold text-slate-700">${e.model}</p>
                                <p class="text-xs text-slate-500">${e.contractor} · Qty: ${e.quantity}</p>
                            </div>
                            <button onclick="removeEquipment(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    `).join('') || '';
                    break;
                case 'issues':
                    const issuesList = document.getElementById('issues-list');
                    issuesList.innerHTML = report.generalIssues.map((issue, i) => `
                        <div class="bg-red-50 border border-red-200 p-3 flex items-start gap-3">
                            <i class="fas fa-exclamation-circle text-red-500 mt-0.5"></i>
                            <p class="flex-1 text-sm text-slate-700">${issue}</p>
                            <button onclick="removeIssue(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    `).join('') || '';
                    break;
                case 'inspections':
                    const inspectionsList = document.getElementById('inspections-list');
                    inspectionsList.innerHTML = report.qaqcNotes.map((note, i) => `
                        <div class="bg-violet-50 border border-violet-200 p-3 flex items-start gap-3">
                            <i class="fas fa-check-circle text-violet-500 mt-0.5"></i>
                            <p class="flex-1 text-sm text-slate-700">${note}</p>
                            <button onclick="removeInspection(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    `).join('') || '';
                    break;
                case 'safety':
                    const safetyList = document.getElementById('safety-list');
                    safetyList.innerHTML = report.safety.notes.map((note, i) => `
                        <div class="bg-green-50 border border-green-200 p-3 flex items-start gap-3">
                            <i class="fas fa-shield-alt text-safety-green mt-0.5"></i>
                            <p class="flex-1 text-sm text-slate-700">${note}</p>
                            <button onclick="removeSafetyNote(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    `).join('') || '';
                    document.getElementById('has-incidents').checked = report.safety.hasIncidents;
                    break;
                case 'visitors':
                    const visitorsList = document.getElementById('visitors-list');
                    visitorsList.innerHTML = report.visitorsRemarks.map((v, i) => `
                        <div class="bg-slate-50 border border-slate-200 p-3 flex items-start gap-3">
                            <i class="fas fa-user text-dot-blue mt-0.5"></i>
                            <p class="flex-1 text-sm text-slate-700">${v}</p>
                            <button onclick="removeVisitor(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    `).join('') || '';
                    break;
                case 'photos':
                    const photosGrid = document.getElementById('photos-grid');
                    photosGrid.innerHTML = report.photos.map((p, i) => `
                        <div class="relative border border-slate-200 overflow-hidden">
                            <img src="${p.url}" class="w-full aspect-square object-cover">
                            <button onclick="removePhoto(${i})" class="absolute top-2 right-2 w-6 h-6 bg-red-600 text-white text-xs flex items-center justify-center"><i class="fas fa-times"></i></button>
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
                                <p class="text-[10px] text-white/80">${p.time}</p>
                            </div>
                        </div>
                    `).join('') || '';
                    break;
            }
        }

        function renderAllSections() {
            ['contractors', 'activities', 'headcounts', 'equipment', 'issues', 'inspections', 'safety', 'visitors', 'photos'].forEach(renderSection);
            updateWeatherDisplay();
        }

        // ============ PREVIEWS & PROGRESS ============
        function updateAllPreviews() {
            const w = report.overview.weather;
            document.getElementById('weather-preview').textContent = w.jobSiteCondition || `${w.generalCondition}, ${w.highTemp}`;
            document.getElementById('contractors-preview').textContent = report.contractors.length > 0 ? report.contractors.join(', ') : 'Tap to add';
            document.getElementById('activities-preview').textContent = report.activities.length > 0 ? `${report.activities.length} activities logged` : 'Tap to add';
            const totalWorkers = report.operations.reduce((sum, o) => sum + (o.supers||0) + (o.foreman||0) + (o.operators||0) + (o.laborers||0) + (o.others||0), 0);
            document.getElementById('headcounts-preview').textContent = totalWorkers > 0 ? `${totalWorkers} workers total` : 'Tap to add';
            const naMarked = report.meta.naMarked || {};
            document.getElementById('equipment-preview').textContent = naMarked.equipment ? 'N/A' : report.equipment.length > 0 ? `${report.equipment.length} items` : 'Tap to add';
            document.getElementById('issues-preview').textContent = naMarked.issues ? 'N/A - No issues' : report.generalIssues.length > 0 ? `${report.generalIssues.length} issues` : 'None reported';
            document.getElementById('inspections-preview').textContent = naMarked.inspections ? 'N/A - No inspections' : report.qaqcNotes.length > 0 ? `${report.qaqcNotes.length} inspections` : 'None reported';
            document.getElementById('safety-preview').textContent = report.safety.hasIncidents ? 'INCIDENT REPORTED' : report.safety.noIncidents ? 'No incidents (confirmed)' : report.safety.notes.length > 0 ? 'Notes added' : 'Tap to confirm';
            document.getElementById('visitors-preview').textContent = naMarked.visitors ? 'N/A - No visitors' : report.visitorsRemarks.length > 0 ? `${report.visitorsRemarks.length} entries` : 'None reported';
            document.getElementById('photos-preview').textContent = report.photos.length > 0 ? `${report.photos.length} photos` : 'No photos';
            updateStatusIcons();
        }

        function updateStatusIcons() {
            const naMarked = report.meta.naMarked || {};
            const sections = {
                'weather': report.overview.weather.jobSiteCondition,
                'contractors': report.contractors.length > 0,
                'activities': report.activities.length > 0,
                'headcounts': report.operations.length > 0,
                'equipment': report.equipment.length > 0 || naMarked.equipment,
                'issues': report.generalIssues.length > 0 || naMarked.issues,
                'inspections': report.qaqcNotes.length > 0 || naMarked.inspections,
                'safety': report.safety.noIncidents || report.safety.hasIncidents || report.safety.notes.length > 0,
                'visitors': report.visitorsRemarks.length > 0 || naMarked.visitors,
                'photos': report.photos.length > 0
            };
            Object.entries(sections).forEach(([section, hasData]) => {
                const statusEl = document.getElementById(`${section}-status`);
                if (!statusEl) return;
                const card = document.querySelector(`[data-section="${section}"]`);
                const isExpanded = card?.classList.contains('expanded');
                if (hasData && !isExpanded) {
                    statusEl.innerHTML = '<i class="fas fa-check text-safety-green text-xs"></i>';
                    statusEl.className = 'w-8 h-8 bg-safety-green/20 border-2 border-safety-green flex items-center justify-center';
                } else if (!isExpanded) {
                    statusEl.innerHTML = '<i class="fas fa-chevron-down text-slate-400 text-xs"></i>';
                    statusEl.className = 'w-8 h-8 border border-slate-300 flex items-center justify-center';
                }
            });
        }

        function updateProgress() {
            let filled = 0;
            let total = 5;
            if (report.overview.weather.jobSiteCondition) filled++;
            if (report.contractors.length > 0) filled++;
            if (report.activities.length > 0) filled++;
            if (report.operations.length > 0) filled++;
            if (report.safety.notes.length > 0 || report.safety.hasIncidents !== undefined) filled++;
            const percent = Math.round((filled / total) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${percent}%`;
        }

        // ============ UTILITIES ============
        function normalizeContractorName(name) {
            const lower = name.toLowerCase().trim();
            const known = {
                'HGBM': ['hgbm', 'hunt gibbs', 'hunt, gibbs', 'the prime', 'prime contractor'],
                'Boh Bros': ['boh', 'boh brothers', 'boh bros'],
                'Metro Electric': ['metro', 'metro electrical', 'electricians'],
                'Allied Concrete': ['allied', 'concrete guys', 'concrete sub']
            };
            for (const [canonical, aliases] of Object.entries(known)) {
                if (aliases.some(alias => lower.includes(alias))) { return canonical; }
            }
            return name.charAt(0).toUpperCase() + name.slice(1);
        }

        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast-msg');
            if (existing) existing.remove();
            const colors = { success: 'bg-safety-green', warning: 'bg-dot-orange', error: 'bg-red-600', info: 'bg-dot-blue' };
            const toast = document.createElement('div');
            toast.className = `toast-msg fixed bottom-24 left-1/2 -translate-x-1/2 ${colors[type] || colors.success} text-white px-6 py-3 font-bold text-sm shadow-lg z-50 flex items-center gap-2 uppercase`;
            toast.innerHTML = `<i class="fas fa-check"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function dismissWarningBanner() {
            document.getElementById('permissionsWarningBanner').classList.add('hidden');
        }

        function checkAndShowWarningBanner() {
            const micGranted = localStorage.getItem('fvp_mic_granted') === 'true';
            const locGranted = localStorage.getItem('fvp_loc_granted') === 'true';
            if (isMobile && (!micGranted || !locGranted)) {
                document.getElementById('permissionsWarningBanner').classList.remove('hidden');
            }
        }

        // ============ N/A MARKING ============
        function markNA(section) {
            if (!report.meta.naMarked) report.meta.naMarked = {};
            report.meta.naMarked[section] = true;
            const btn = document.getElementById(`${section}-na-btn`);
            if (btn) {
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>Marked as N/A';
                btn.className = 'w-full p-3 bg-safety-green/20 border-2 border-safety-green text-safety-green text-sm font-medium uppercase cursor-default';
                btn.onclick = () => clearNA(section);
            }
            saveReport();
            updateAllPreviews();
            showToast('Marked as N/A');
        }

        function clearNA(section) {
            if (report.meta.naMarked) { delete report.meta.naMarked[section]; }
            const btn = document.getElementById(`${section}-na-btn`);
            if (btn) {
                const labels = { equipment: 'Mark as N/A', issues: 'No Issues - Mark as N/A', inspections: 'No Inspections - Mark as N/A', visitors: 'No Visitors - Mark as N/A' };
                btn.innerHTML = `<i class="fas fa-ban mr-2"></i>${labels[section] || 'Mark as N/A'}`;
                btn.className = 'w-full p-3 bg-slate-100 border border-slate-300 text-slate-600 hover:bg-slate-200 transition-colors text-sm font-medium uppercase';
                btn.onclick = () => markNA(section);
            }
            saveReport();
            updateAllPreviews();
            showToast('N/A cleared');
        }

        function updateNAButtons() {
            const naMarked = report.meta.naMarked || {};
            Object.keys(naMarked).forEach(section => {
                if (naMarked[section]) {
                    const btn = document.getElementById(`${section}-na-btn`);
                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-check mr-2"></i>Marked as N/A';
                        btn.className = 'w-full p-3 bg-safety-green/20 border-2 border-safety-green text-safety-green text-sm font-medium uppercase cursor-default';
                        btn.onclick = () => clearNA(section);
                    }
                }
            });
        }

        function finishReport() {
            report.overview.endTime = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            report.meta.interviewCompleted = true;
            if (report.overview.startTime) {
                const start = new Date(`2000/01/01 ${report.overview.startTime}`);
                const end = new Date(`2000/01/01 ${report.overview.endTime}`);
                const diffMs = end - start;
                const hours = Math.floor(diffMs / (1000 * 60 * 60));
                const mins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                report.overview.shiftDuration = `${hours}.${String(mins).padStart(2, '0')} hours`;
            }
            if (report.safety.notes.length === 0) {
                report.safety.notes.push('No safety incidents reported.');
            }
            saveReport();
            window.location.href = 'report.html';
        }

        // ============ EVENT LISTENERS ============
        document.getElementById('site-conditions-input').addEventListener('change', (e) => {
            report.overview.weather.jobSiteCondition = e.target.value;
            saveReport();
        });

        document.getElementById('no-incidents').addEventListener('change', (e) => {
            if (e.target.checked) {
                report.safety.hasIncidents = false;
                report.safety.noIncidents = true;
                document.getElementById('has-incidents').checked = false;
            } else {
                report.safety.noIncidents = false;
            }
            saveReport();
            updateAllPreviews();
        });

        document.getElementById('has-incidents').addEventListener('change', (e) => {
            report.safety.hasIncidents = e.target.checked;
            if (e.target.checked) {
                report.safety.noIncidents = false;
                document.getElementById('no-incidents').checked = false;
            }
            saveReport();
            updateAllPreviews();
        });

        document.getElementById('photoInput').addEventListener('change', handlePhotoInput);
        document.getElementById('contractor-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') addContractor(); });
        document.getElementById('headcount-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') addHeadcount(); });
        document.getElementById('equipment-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') addEquipment(); });

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            report = getReport();
            checkAndShowWarningBanner();
            if (report.overview.weather.generalCondition === 'Syncing...' || report.overview.weather.generalCondition === '--') {
                await fetchWeather();
            }
            renderAllSections();
            updateAllPreviews();
            updateProgress();
            updateNAButtons();
            document.getElementById('no-incidents').checked = report.safety.noIncidents || false;
            document.getElementById('has-incidents').checked = report.safety.hasIncidents || false;
        });
    </script>
</body>
</html>
